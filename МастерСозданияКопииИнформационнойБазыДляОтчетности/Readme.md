# Мастер создания копии информационной базы для отчетности

Прототип инструмента для подготовки реплики в режиме только для чтения к использованию. Позволяет использовать "read-only" реплики как обычные информационные базы 1С.

Материалы по другим темам Вы можете найти на сайте [ypermitin.github.io](https://ypermitin.github.io/), а новости по проектам или новым материалам в [Telegram-канале](https://t.me/TinyDevVault).

## Состав

* [media](media) - медиафайлы для документации данной разработки.
* [src](src) - файлы исходного кода.

## Небольшое введение

Давным давно, а точнее больше года назад, была создана публикация ["Копия базы 1С для отчетов. Или как выжить с тяжелой отчетностью"](https://ypermitin.github.io/sqlserver/2019/04/22/Копия-базы-1С-для-отчетов.-Или-как-выжить-с-тяжелой-отчетностью.html), в которой была рассмотрена тема создания копии баз данных для распределения нагрузки информационной системы между её копиями. В комментариях к публикации также можно найти интересную информацию.

С тех пор по этой теме появилось несколько интересных новостей:

* [Механизм копий баз данных](https://its.1c.ru/db/v8314doc/bookmark/dev/TI000002104#:~:text=Механизм%20копий%20базы%20данных%20позволяет,существовать%20несколько%20копий%20базы%20данных.) от фирмы "1С" (только для лицензии КОРП), который также позволяет перенести часть нагрузки на дополнительную реплику баз данных средствами платформы. О новой функциональности уже была публикация с дополнительными ссылками на Инфостарт.
* Рассмотренные в статье некоторые способы работы с "read-only" репликами перестали работать, т.к. запуск клиентского приложения теперь всегда проверяет наличие этого ограничения. Проверено на 8.3.17 - толстый клиент в обычном приложении теперь запустить нельзя.

Вот так выглядит ошибка запуска толстого клиента в обычном приложении на платформе 8.3.17. Имя базы, конечно же, у Вас будет отличаться.

![0.1 Ошибка](./media/0.1%20%D0%9E%D1%88%D0%B8%D0%B1%D0%BA%D0%B0.png)

А вот такая ошибка будет при запуске тонкого клиента.

![0.2 Ошибка](./media/0.2%20%D0%9E%D1%88%D0%B8%D0%B1%D0%BA%D0%B0.png)

Теперь просто так запустить клиентское приложение на доступной только для чтения реплике не получится.

До появления новых "фишек" от фирмы "1С", функционал распределения нагрузки (как в автоматическом, так и в ручном режиме разработчиками) был доступен и ранее. Коллеги из [Softpoint](https://www.softpoint.ru/) создали потрясающий продукт [DataCluster](https://www.softpoint.ru/solutions/data-cluster/) для SQL Server, который отлично справляется с этими задачами. Если эта тема для Вас актуальна и важна, то пройти мимо их продукта было бы не правильно.

Также есть и другие способы использования доступных только для чтения реплик, но все они имеют существенные ограничения в использовании:

* Можно опубликовать веб-сервисы и HTTP-сервисы информационной базы, связанной с этой репликой БД и обращаться к ней через них. Но все обращения придется реализовывать разработчикам. И не факт, что этот способ не перестанет работать в будущем.
* Можно обращаться к копии базы через внешние источники данных. Также потребует значительных трудозатрат в разработке.

Но что, если решение от Softpoint для Вас избыточно или сильно дорогое, но копию базы для отчетности все же хочется иметь. А напрягать разработчиков новыми фишками нет возможности. При этом Вы готовы мириться с некоторыми ограничениями. Вот для таких случаев и создавалась эта разработка, о которой и пойдет речь далее.

## Как создать копию

Но как же создать эту копию базы? Да еще и так, чтобы актуальность данных в ней была максимально приближена к основной рабочей базе. Ведь формирование отчетов может потребовать максимально актуальных данных и вариант с обновлением копии базы каждую ночь из бэкапа не подойдет.

Мы не будем рассматривать каким лучше способом создавать копию базы для отчетности. Частично эту тему затрагивали в предыдущей публикации. Кратко напомню, что есть несколько путей (все будет описываться для SQL Server, т.к. инструмент сейчас работает только с этой СУБД):

* Простое бэкапирование и восстановление - медленно, дешево, сердито, неэффективно. Но если подходит, то нет смысла пробовать что-то другое.
* Доставка логов транзакций - замечательная возможность SQL Server для создания "почти в реальном времени" копии базы данных. С определенными настройками позволяет создавать копию базы данных в режиме "только для чтения". Есть ограничения по обновлению, т.к. потребуется "отключение" сессий и связанные с этим проблемы.
Репликация. SQL Server позволяет использовать репликацию данных разных видов. На самом деле штатно использовать репликацию к базам данных 1С практически невозможно и нужны некоторые стероиды для этого.
* AlwaysOn - группы доступности AlwaysOn позволяют создавать копии базы данных на других инстансах практически в реальном времени. О них мы также говорили в предыдущей публикации. Также там были ссылки по настройке.
* Моментальные снимки - еще один интересный механизм SQL Server, но с огромными ограничениями для основной базы данных. Для использования на продакшене нужно любить рисковать и закрывать глаза на очевидные проблемы :)

Зеркалирование для этих целей не подойдет, т.к. копия базы недоступна для использования. Да и не для этого оно создавалось, а для отказоустойчивости.

Я предпочитаю AlwaysOn всем остальным способам, т.к. на мой взгляд - это самое эффективное средство создания копии базы данных в реальном времени. Идеальный вариант для переноса на эту базу OLAP-нагрузок.

Если Вам интересна тема работы репликации и других механизмов SQL Server в части создания копий баз данных, то дайте знать в комментариях. Об этом можно написать очень много, в т.ч. и в контексте 1С. И эта тема полна нюансов.

## Назначение и возможности

Наконец-то мы подобрались к инструменту. Главное его назначение - это помочь использовать реплику "только для чтения" как обычную информационную базу 1С. То есть к базе данных в режиме "read-only" можно будет подключить информационную базу 1С в кластере и работать с ней привычным образом:

* Запускать клиентские приложения (тонкий и толстый клиент, обычное и управляемое приложение)
* Формировать отчеты, печатные формы и т.д.
* Для использования клиентского приложения чаще всего не нужны никакие доработки конфигураций. По крайней мере типовых конфигураций, про остальные надо смотреть по ситуации.
* Часть функционала будет работать как обычно, не смотря на то, что база только для чтения:
    * Будут сохраняться настройки форм
    * Пользовательские настройки отчетов (НЕ ВАРИАНТОВ ОТЧЕТОВ!)
    * Можно открывать внешние отчеты и обработки
    * История работы пользователей будет работать как обычно
    * И многое другое.
* Можно даже выполнять некоторые операции изменения данных, но при этом по факту в базе ничего не изменится:
    * Запись элементов справочников
    * Запись регистров
    * Некоторые служебные операции

В общем, у Вас будет информационная база, работающая с копией рабочей базы в режиме "только для чтения" с минимальными неудобствами. Минимальными для текущей ситуации :). Вот пример работы с такой базой (Демобаза Управление торговлей 11), и когда можно все-таки нарваться на ошибки в работе.

![1. Пример работы с копией базы](./media/1.%20%D0%9F%D1%80%D0%B8%D0%BC%D0%B5%D1%80%20%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D1%8B%20%D1%81%20%D0%BA%D0%BE%D0%BF%D0%B8%D0%B5%D0%B9%20%D0%B1%D0%B0%D0%B7%D1%8B.gif)

Как Вы могли увидеть на анимации - отчеты, различные интерфейсные панели, открытие и запись элементов справочников работают как обычно. Данные только не изменяются :) Ошибка может возникнуть только при попытке создания новых записей и чаще всего это относится к объектным сущностям (справочники, документы и т.д.) - все это из-за особенностей работы платформы 1С.

Именно создать возможность использования копии базы в режиме "только для чтения" и является целью этой разработки.

Основными возможностями инструмента являются:

* Анализ исходной копии базы данных в режиме только для чтения для последующего использования.
* Формирование скриптов для создания и настройки служебной базы, которая позволяет использовать копию базы через подключение к кластеру серверов 1С.
* Выставление защиты от операций изменения данных на уровне служебной базы данных: при этом может быть защита в виде игнорирования таких операций, либо появления исключений.
* Формирование скриптов для пересоздания служебной базы данных.

## Требования

Минимальные требования к работе:

* Платформа 1С версии 8.3.* (на 8.2 тоже будет работать, но потребуются адаптации скриптов).
* СУБД Microsoft SQL Server 2008 и выше. Основная работа тестировалась на версии SQL Server 2014.
* Служебная база данных создается на том же инстансе, на котором находится реплика только для чтения. НО возможно и на другом сервере через, например, создание связанных серверов. Все это уже другая история.
* Возможность подключения через ADO c сервера 1С к экземпляру SQL Server с правами к копии базы данных.
* Только управляемые формы. Для использования в обычном приложении используйте известные обходные пути.

Далее кратко опишем принцип работы.

## Принцип работы

Сам принцип работы очень простой. Допустим, у нас есть два сервера: SQL-1 и SQL-2. На SQL-1 у нас основная база, в ней работают пользователи и все хорошо. На SQL-2 есть копия базы, сформированная через AlwaysOn и находящаяся в режиме "только для чтения". Обе базы имеют имя "ut_11_always_on". Просто для примера.

Напрямую подключить реплику базы "ut_11_always_on" с сервера SQL-2 в кластер 1С мы не можем. Точнее можем, но запускать клиентские приложения в обычном виде не сможем (ошибки см. в выше). Но можно пойти другим путем:

1. На сервере SQL-2 создать служебную базу "ut_11_always_on_fake" вручную с пустым составом таблиц.
2. Далее создать представления (view) для всех таблиц базы "ut_11_always_on". Представления будут созданы в служебной базе "ut_11_always_on_fake", но запросы будут выполняться к таблицам базы "ut_11_always_on".
3. При этом часть служебных таблиц информационной базы перенести все же не представлениями, а обычными таблицами и скопировать в них данные из реплики. К этим системным таблицам, например, относятся:
    * V8Users
    * DBSchema
    * Config
    * ConfigSave
    * _UsersWorkHistory
    * И другие.
4. При подключении информационной базы в кластере к этой служебной базе данных платформа 1С по факту будет работать с базой, которая не находится в режиме только для чтения. А системные таблицы и вовсе могут изменяться. Та же история работы пользователя спокойно будет записываться в таблицу "_UsersWorkHistory".
5. Чтобы избежать ошибок с операциями INSERT, UPDATE, DELETE к нашей служебной базе мы создадим триггеры для представлений, которые позволят эти операции максимально игнорировать.
6. Там где игнорировать нельзя - будет выдано исключение, но таких операций меньшинство и их легко избегать. В том числе и настройками прав на уровне 1С.
7. Если системные таблицы изменяются в реплике, то их обновляем с помощью скриптов и в служебной базе (например, если мы обновим конфигурацию, добавим расширение или изменим права доступа пользователей - то один запуск скрипта и все данные в таблицах обновлены).

В случае возникновения ошибок в служебной базе нет причин чего-то бояться, ведь данные основной рабочей базы только для чтения и никаких потерь не предвидится. Самое плохое что может случиться - это вылет сеансов служебной информационной базы в период ее актуализации. Поэтому лучше это все же делать вне рабочего времени или в отведенный период регламентных работ.

Все эти принципы работы использовались в этой разработке, а также учтены некоторые нюансы использования.

## Примеры использования

Рассмотрим очень простой пример. Как и ранее, пусть будут два сервера SRV-SQL-01-VM и SRV-SQL-02-VM. На SRV-SQL-02-VM есть копия базы, сформированная через AlwaysOn и находящаяся в режиме "только для чтения". Обе базы имеют имя "ut_11_always_on". Вот как это выглядит на стороне СУБД.

![2. Разные сервера](./media/2.%20%D0%A0%D0%B0%D0%B7%D0%BD%D1%8B%D0%B5%20%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80%D0%B0.png)

В основной базе запускаем инструмент и на первом этапе настраиваем подключение. Все параметры индивидуальны. В том числе и пароль не обязательно у Вас должен быть как 16 звездочек :).

![3. Настройка мастера](./media/3.%20%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0%20%D0%BC%D0%B0%D1%81%D1%82%D0%B5%D1%80%D0%B0.png)

Далее определяемся с именем служебной базы данных, через которую мы будем работать с репликой основной БД. Пусть для разнообразия это будет "ut_11_always_on_writetable_fake_ver2". Почему? Да просто так :). Установим это имя в настройках адаптированной базы и нажмем "Заполнить настройки объектов базы по умолчанию".

![4. Настройки объектов](./media/4.%20%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B8%20%D0%BE%D0%B1%D1%8A%D0%B5%D0%BA%D1%82%D0%BE%D0%B2.png)

Эти настройки используются для формирования скриптов создания объектов служебной базы.

После этого заполняются настройки переноса объектов из реплики в служебную базу данных, а также на вкладке "Скрипты" будут сформированы их тексты для ручного запуска. Скрипт создания базы выполнять не обязательно, если Вы её создали с нужными параметрами вручную.

![5. Сформированные скрипты](./media/5.%20%D0%A1%D1%84%D0%BE%D1%80%D0%BC%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%BD%D1%8B%D0%B5%20%D1%81%D0%BA%D1%80%D0%B8%D0%BF%D1%82%D1%8B.gif)

Тексты скриптов можно переформировать вручную, если были изменены настройки объектов служебной базы по умолчанию. После запуска сформированных скриптов в том же порядке, в котором они были представлены в обработке, мы будем иметь служебную базу с представлениями вместо таблиц, исключая только служебные сущности.

![6. Результат работы](./media/6.%20%D0%A0%D0%B5%D0%B7%D1%83%D0%BB%D1%8C%D1%82%D0%B0%D1%82%20%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D1%8B.png)

Именно эту базу мы можем подключить в кластере 1С и использовать ее в обычном режиме. В самом начале публикации мы уже видели как это смотрится в клиентском приложении. Посмотрим еще раз: сверху основная база, снизу "read-only" копия.

![7. Профит!](./media/7.%20%D0%9F%D1%80%D0%BE%D1%84%D0%B8%D1%82!.gif)

## Послесловие

Конечно, не все так гладко. Все же могут возникать ошибки при попытке изменения некоторых таблиц, поэтому нужно максимально это предотвратить:

* Либо с помощью инструкций пользователям по работе с базой для отчетов.
* Либо с помощью изменения системы прав доступа в конфигурации.

Дополнительно необходимо для копии отключать регламентные задания, чтобы не произошло чего-нибудь непредвиденного. Если идти еще дальше, то в самой конфигурации можно добавить модули определения на какой реплике выполняется код (основной или дополнительной) и в зависимости от этого выполнять проверки и алгоритмы.

Также можно пойти дальше и автоматизировать обновление служебных таблиц данными из реплики после выполнения обновлений основной базы. Можно переносить только часть данных служебных таблицы. Плюс ко всему можно разрешить редактирование некоторых справочников только для отчетной базы. Например, это справочник вариантов отчетов.

В любом случае, инструмент является лишь прототипом, который Вы можете использовать для своей ситуации. В большинстве случае мелкие доработки скриптов нужны почти всегда. Если тема будет интересна сообществу и разработка будет поддержана, то ее функционал будет развиваться:

* Расширение настроек объектов служебной базы.
* Более умное обновление объектов базы.
* Автоматизация обновления после изменения основной базы или реплики.
* Добавлена поддержка PostgreSQL.
* Значительно улучшить удобства работы со служебной базой и инструменты автоматизации.
* И многое другое.