# Транслятор запросов 1С в SQL

Инструмент для трансляции запросов платформы 1С в SQL, а также их диагностики.

Материалы по другим темам Вы можете найти на сайте [ypermitin.github.io](https://ypermitin.github.io/), а новости по проектам или новым материалам в [Telegram-канале](https://t.me/TinyDevVault).

## Состав

* [media](media) - медиафайлы для документации данной разработки.
* [src](src) - файлы исходного кода.
    * [8.3](src/8.3) - исходный код обработки для платформы 1С версии 8.3.
    * [8.2](src/8.2) - исходный код обработки для платформы 1С версии 8.2.

## Назначение и возможности

Инструмент "Транслятор запросов 1С в SQL" предназначен для быстрого и удобного получения SQL-запросов, которые генерируются платформой 1С в различных ситуациях: либо выполнение конкретного запроса на языке 1С, либо запуск кода встроенного языка, который также может формировать SQL-запросы к базе данных. 

Кроме этого, по полученным запросам можно посмотреть дополнительную информацию для диагностики их работы (затраченные ресурсы, планы запроса и другое). Ниже на анимации Вы можете видеть длинный пример работы транслятора. О каждой функции инструмента ниже будет рассказано подробнее.

![Пример использования инструмента](./media/1.%20%D0%9F%D1%80%D0%B8%D0%BC%D0%B5%D1%80%20%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F%20%D0%B8%D0%BD%D1%81%D1%82%D1%80%D1%83%D0%BC%D0%B5%D0%BD%D1%82%D0%B0.gif)

Основными возможностями инструмента являются:

* **Перевод запроса 1С в SQL с учетом всех особенностей работы платформы.** Например, если выполнять запрос к виртуальной таблице "Движения с субконто", то фактически будет выполнен не 1 запрос, а целая серия вспомогательных запросов. Инструмент это покажет. Также будут собраны все связанные служебные запросы (получение информации о метаданных, создание и очистка временных таблиц и др.).
* **Перевод запросов платформы 1С в SQL при выполнении конструкций кода встроенного языка.** Вам когда-нибудь было интересно как работает функция "НайтиПоНаименованию(...)"? С помощью этой обработки Вы найдете ответы на все вопросы.
* **Получение информации о затраченных ресурсах каждого отловленного запроса.** Для каждого запроса будут получены показатели использования CPU, логических и физических чтений, операций записи и количество возвращенных записей в запросе.
* **Возможность посмотреть план для каждого собранного запроса** (если такой план есть на стороне СУБД). Вы можете сразу открыть его в SQL Server Management Studio или же сохранить его на диск в формате "*.sqlplan".
* **Инструмент может быть использован как на тестовом , так и на рабочем окружении.** Сам сбор информации о запросах создает минимальную нагрузку на сервер. Подробнее о принципах работы инструмента Вы можете прочитать ниже.
* **Вывод служебной информации об анализируемой базе данных и СУБД.**

![Пример информации о СУБД в базе данных](./media/2.%20%D0%A1%D0%BB%D1%83%D0%B6%D0%B5%D0%B1%D0%BD%D0%B0%D1%8F%20%D0%B8%D0%BD%D1%84%D0%BE%D1%80%D0%BC%D0%B0%D1%86%D0%B8%D1%8F.png)

## Требования

Для работы с инструментов необходимо:

* Платформа 1С версии 8.3.5 и выше. Для версии 8.2 есть отдельная обработка, но с некоторыми ограниченными функциями.
* СУБД Microsoft SQL Server 2008 и выше. 2008 редакция поддерживается в ограниченном режиме в части получения данных расширенных событий по запросам, а также в скорости получения данных.
* Возможность подключения через ADO c сервера 1С к экземпляру SQL Server с правами "sysadmin".
* Только управляемые формы. Для использования в обычном приложении используйте известные обходные пути.

### Ограничения для SQL Server 2008

Из-за особенностей работы Extended Events для редакции SQL Server 2008 инструмент имеет следующие ограничения:

Не все данные по запросам могут быть получены (количество чтений, CPU и др.).
Из-за внутренних особенностей работы сессий Extended Events для достоверного получения данных расширенных событий приходиться делать паузку в 30 секунд перед получением данных из сессий.
Из-за ограничений условий для отбираемых событий в некоторых случаях может быть выполнена обработка большого массива запросов, чтобы исключить излишние данные при выводе.
В остальном больших отличий пока не было найдено.

### Итого по требованиям

Таким образом, данная разработка может оказаться отличным инструментом для диагностики работы запросов и кода встроенного языка в части взаимодействия с СУБД, а также для изучения работы платформы 1С с СУБД. Тем более если диагностику нужно выполнить на рабочем окружении!

## Принцип работы

Код обработки открыт и Вы можете самостоятельно его изучить. Сейчас же опишем общий принцип работы инструмента:

1. Начинаем серверный вызов, в контексте которого и будет выполняться сбор информации.
2. Определяем идентификатор соединения с СУБД, которое выделено платформой 1С из пула соединений для текущего сеанса (серверного вызова). Т.к. платформа использует пул соединений, то для гарантии того, что это соединение не будет использоваться другими сеансами 1С выполняется несколько трюков с временными таблицами.
3. После того как мы определили идентификатор соединения, запускаем сессию Extended Events для сбора данных о выполняемых запросах с фильтром по базе данных и по соединению.
4. Выполняем запросы или конструкции кода встроенного языка для анализа.
5. Обрабатываем собранные данные и завершаем сессии сбора данных.
6. Очистка от служебных данных.

Профит! Вся информация получена. За счет "точечной" фильтрации по соединению мы можем собирать данные в многопользовательской среде, т.к. такие фильтры и подход сбора информации практически исключает попадание лишних запросов других сеансов в собранные данные.

Да, для сбора информации НЕ используется технологический журнал. Все базируется на расширенных событиях SQL Server, которые позволяют достаточно эффективно собирать данные для анализа, не мешая основной работе приложения. Дополнительную [информацию об Extended Events можно посмотреть здесь](https://github.com/YPermitin/SQLServerTools/tree/master/SQL-Server-Diagnostics/Extended-Events). Единственный минус такого подхода - то, что запрос / конструкции кода все же выполняются, поэтому если в них будет запущено что-то тяжелое, то именно они и могут повлиять на производительность и стабильность работы. Это стоит учитывать, если Вы пользуетесь инструментом на рабочем окружении.