# Генератор представлений для базы данных 1С

Обработка для генерации скриптов создания представлений баз данных 1С. Поддержка SQL Server + некоторые служебные функции.

Материалы по другим темам Вы можете найти на сайте [ypermitin.github.io](https://ypermitin.github.io/), а новости по проектам или новым материалам в [Telegram-канале](https://t.me/TinyDevVault).

## Состав

* [media](media) - медиафайлы для документации данной разработки.
* [src](src) - файлы исходного кода.

## Назначение и возможности

Простейшая обработка для генерации представлений в базах данных 1С. Формирует скрипты для ручного запуска. Подобные инструменты чаще всего используются для создания возможности интеграции с базами данных 1С напрямую, обходя обращение через сервер 1С и стандартные средства интеграции. Чаще всего из соображений оптимизации производительности или интеграции с инструментами, которые не могут использовать штатные механизмы платформы 1С (Power BI, например).

## Требования

Обработка тестировалась на платформе 8.3.16 и старше и с редакциями SQL Server 2014 и старше.

В остальных случаях может потребоваться доработка и адаптация под различные изменения платформы 1С или СУБД.

## Принцип работы

Работа с обработкой выполняется в несколько этапов. На первом этапе нужно настроить подключение к базе 1С, находящейся на инстансе SQL Server. На этом этапе указываем сервер, имя базы данных, а также параметры аутентификации.

![1. Настройки подключения](./media/1.%20%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B8%20%D0%BF%D0%BE%D0%B4%D0%BA%D0%BB%D1%8E%D1%87%D0%B5%D0%BD%D0%B8%D1%8F.png)

На втором этапе нужно указать настройки создания представлений. По факту указываем имя базы данных, где нужно создать представления и нажимаем кнопку "Заполнить настройки объектов базы по умолчанию". Имя базы данных для представлений можно указать то же самое, что и имя исходной базы. Настройка сделана для того, чтобы можно было создавать эти объекты в отдельной БД и не вмешиваться в работу основной базы 1С. Тут же есть параметр, позволяющий сгенерировать скрипт для удаления всех существующих представлений.

![2. Генератор представлений](./media/2.%20%D0%93%D0%B5%D0%BD%D0%B5%D1%80%D0%B0%D1%82%D0%BE%D1%80%20%D0%BF%D1%80%D0%B5%D0%B4%D1%81%D1%82%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B9.png)

На последнем этапе мы получим 4 скрипта для создания представлений и некоторых служебных объектов:

1. Скрипт создания базы для представлений, если ее нет. Больше используется как шаблон, т.к. в большинстве случаев нужно явно указывать необходимые пути к файлам и т.д.
2. Скрипт удаления существующих представлений. Также только в качестве шаблона, т.к. в базе могут быть представления, не связанные с текущей работой. Будьте осторожны при использовании!
3. Скрипт создания представлений. То, для чего мы обработку и запускаем. При создании скриптов придерживаемся следующих принципов:
    * Данные отображаем как есть для лучшей производительности. То есть никаких смещений к датам или преобразования GUID'ов к привычному виду не выполняется. В большинстве случаев это приведет к серьезной деградации производительности. Преобразование данных к нужному представлению нужно выполнять в финальной части запроса.
    * Имена представлений строятся как "v_<ВидОбъекта>_<ТипОбъекта>". Для табличных частей это "v_<ВидОбъекта>_<ТипОбъекта>_ТЧ_<ИмяТабличнойЧасти>". Также в некоторых случаях может быть добавлено назначение объекта.
    * Для перечислений добавлено поле "Наименование", позволяющее просматривать строковое значение перечисления, которое в базе явно не хранится.
    * Поля представлений и объектов такие же как и в конфигурации, то есть читаемые. Для некоторых таблиц представление определяется специальным способом, т.к. стандартное описание структуры базы данных не дает информации. Таким образом список полей с читаемыми названиями устанавливаются в большинстве случаев.
4. Скрипт создания служебных объектов. Это вспомогательные функции:
    * [dbo].[fn_ConvertBoolean_From1CToSql] - конвертирует привычное строковое представление GUID'а 1С в формат SQL (binary(16)).
    * [dbo].[fn_ConvertBoolean_FromSqlTo1C] - делает обратную операцию по сравнению с [dbo].[fn_ConvertBoolean_From1CToSql].
    * [dbo].[fn_ConvertGuid_FromSqlTo1C] - преобазует значение типа булево из binary(1) как хранится в SQL в тип bit.
    * [dbo].[fn_ConvertGuid_From1CToSql] - делает обратную операцию по сравнению с [dbo].[fn_ConvertGuid_FromSqlTo1C].

![3. Подготовка представлений](./media/3.%20%D0%9F%D0%BE%D0%B4%D0%B3%D0%BE%D1%82%D0%BE%D0%B2%D0%BA%D0%B0%20%D0%BF%D1%80%D0%B5%D0%B4%D1%81%D1%82%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B9.png)

На этом основной функционал закончен.

## Несколько примеров

Немного наглядных примеров работы с представлениями.

### Запросы к документу "Реализация товаров и услуг"

Например, в базе "Бухгалтерии предприятия" 3.0 были созданы представления для документа реализации товаров и услуг.

![4. Пример созданных представлений](./media/4.%20%D0%9F%D1%80%D0%B8%D0%BC%D0%B5%D1%80%20%D1%81%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85%20%D0%BF%D1%80%D0%B5%D0%B4%D1%81%D1%82%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B9.png)

В каждом представлении созданы поля, имена которых совпадают с полями в конфигурации 1С.

![5. Что в представлении](./media/5.%20%D0%A7%D1%82%D0%BE%20%D0%B2%20%D0%BF%D1%80%D0%B5%D0%B4%D1%81%D1%82%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B8.png)

Напишем запрос, который выведет дату и список товаров из таб. части "Товары" с отбором по конкретному документу.

```sql
  SELECT 
	  -- Выводим дату документа и применяем смещение
	  dateadd(year, -2000, dt1.[Дата]) AS [ДатаДокумента],
	  -- Выводим имя номенклатуры
	  dt3.[Наименование]
  FROM [buh_3_0_88_22].[dbo].[v_ДОК_РеализацияТоваровУслуг] AS dt1
	LEFT JOIN [buh_3_0_88_22].[dbo].[v_ДОК_РеализацияТоваровУслуг_ТЧ_Товары] AS dt2
	ON dt1.[СсылкаЗначение] = dt2.[СсылкаЗначение]
	LEFT JOIN [buh_3_0_88_22].[dbo].[v_СПР_Номенклатура] AS dt3
	ON dt2.[НоменклатураЗначение] = dt3.[СсылкаЗначение]
  -- Отбор по конкретному документу по GUID
  WHERE dt1.[СсылкаЗначение] = [dbo].[fn_ConvertGuid_From1CToSql]('944C1332-CE6F-11E5-982D-14DAE9B19A48')
```

Результат простой.

![6. Результат запроса к представлении](./media/6.%20%D0%A0%D0%B5%D0%B7%D1%83%D0%BB%D1%8C%D1%82%D0%B0%D1%82%20%D0%B7%D0%B0%D0%BF%D1%80%D0%BE%D1%81%D0%B0%20%D0%BA%20%D0%BF%D1%80%D0%B5%D0%B4%D1%81%D1%82%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B8.png)

Без комментариев, все должно быть и так понятно.

### Запросы к служебным таблицам

Кроме стандартных объектов, мы имеем доступ к служебным таблицам.

![7. Представления для служебных таблиц](./media/7.%20%D0%9F%D1%80%D0%B5%D0%B4%D1%81%D1%82%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D1%8F%20%D0%B4%D0%BB%D1%8F%20%D1%81%D0%BB%D1%83%D0%B6%D0%B5%D0%B1%D0%BD%D1%8B%D1%85%20%D1%82%D0%B0%D0%B1%D0%BB%D0%B8%D1%86.png)

Удобочитаемые имена для этих таблиц также установлены.

### Служебные объекты

Представления создаются и для служебных таблиц. Например, для регистра накопления создаются представления для итогов и служебных таблиц с настройками.

![8. Служебные объекты](./media/8.%20%D0%A1%D0%BB%D1%83%D0%B6%D0%B5%D0%B1%D0%BD%D1%8B%D0%B5%20%D0%BE%D0%B1%D1%8A%D0%B5%D0%BA%D1%82%D1%8B.png)

При этом те поля, для которых не удалось найти удобное представление, будут названы как есть.

### Запрос к перечислениям

Строковые значения перечислений не хранятся в таблицах базы в явном виде. Но по факту мы можем эти значения в перечислениях получать. Например, вот запрос.

```sql
SELECT [СсылкаЗначение]
      ,[Порядок]
      ,[Наименование]
  FROM [buh_3_0_88_22].[dbo].[v_ПРЧ_КатегорииТранспортныхСредств]
```

И вот результат.

![9. Представления к перечислениям](./media/9.%20%D0%9F%D1%80%D0%B5%D0%B4%D1%81%D1%82%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D1%8F%20%D0%BA%20%D0%BF%D0%B5%D1%80%D0%B5%D1%87%D0%B8%D1%81%D0%BB%D0%B5%D0%BD%D0%B8%D1%8F%D0%BC.png)

Может быть полезно для форматирования результата запроса в читаемый вид, например в отчетах.