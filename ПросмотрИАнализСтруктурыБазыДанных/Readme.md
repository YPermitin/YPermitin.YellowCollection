# Просмотр и анализ структуры базы данных

Отчет для просмотра и анализа структуры базы данных с поддержкой файловых баз (ограниченный режим), а также баз на SQL Server и PostgreSQL.

Материалы по другим темам Вы можете найти на сайте [ypermitin.github.io](https://ypermitin.github.io/), а новости по проектам или новым материалам в [Telegram-канале](https://t.me/TinyDevVault).

## Состав

* [media](media) - медиафайлы для документации данной разработки.
* [src](src) - файлы исходного кода.

## Назначение и возможности

Отчет предназначен для просмотра и анализа структуры информационных баз 1С. Может быть полезным инструментам для администраторов, специалистов по производительности и энтузиастов, изучающих работу платформы на уровне базы данных.

![1. Основная форма отчета](./media/1.%20%D0%9E%D1%81%D0%BD%D0%BE%D0%B2%D0%BD%D0%B0%D1%8F%20%D1%84%D0%BE%D1%80%D0%BC%D0%B0%20%D0%BE%D1%82%D1%87%D0%B5%D1%82%D0%B0.png)

Основные возможности отчета:

* Отображение таблиц базы данных, их полей и индексов с учетом связей между объектами базы данных и метаданными конфигурации.
* Вычисление размера таблиц и индексов для объектов конфигурации, а также количества записей в них.
* Отображение НЕплатформенных индексов в базе (те, что были добавлены вручную администратором или разработчиком).
* Вывод дополнительных атрибутов СУБД для полей таблицы, индексов и их структуры (например, это возможность установки значения NULL, размер каждого отдельного индекса, проверка наличия платформенного индекса в базе данных, порядок полей в индексе и таблицах и др.).
* Получение информации обо всех таблицах информационной базы, а не только тех, что доступны через "ПолучитьСтруктуруХраненияБазыДанных()". Например, отчет позволит посмотреть информацию о системных таблицах "V8USERS" и "PARAMS", а также отобразит таблицы другие служебные / системные таблицы.
* Дополнительная классификация объектов и их частей. Например, добавлены поля "Вид объекта", "Тип объекта", доп. описание полей составных типов данных и др.
* Расширенное отображение типа данных 1С для полей.
10 предопределенных вариантов отчетов с различной детализацией.
* Гибкая настройка отображения и компоновки данных с помощью штатных возможностей системы компоновки данных.
* Поддержка подсистем БСП (варианты отчетов и дополнительные отчеты и обработки).

![2. Настройки подключения](./media/2.%20%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B8%20%D0%BF%D0%BE%D0%B4%D0%BA%D0%BB%D1%8E%D1%87%D0%B5%D0%BD%D0%B8%D1%8F.png)

Выше показаны настройки подключения к базе данных для получения дополнительной информации. Ниже, под спойлером, Вы найдете подробное описание каждой настройки.

Настройки достаточно простые:

* Тип СУБД - какой тип СУБД используется для текущей информационной базы. Доступные варианты:
    * Файловый - отчет получает только ту информацию, что доступна штатным методом платформы "ПолучитьСтруктуруХраненияБазыДанных()".
    * SQLServer - отчет будет получать дополнительную информацию из базы данных на сервере СУБД SQL Server. Используйте этот вариант, если
    * PostgreSQL - отчет также будет использовать базу данных на PG для получения доп. информации. Используйте ее, если база развернута на этой СУБД.
* Запросы с клиента - эта опция позволяет выполнять запросы для получения расширенных данных из СУБД со стороны клиентского приложения 1С:Предприятие. Зачем это нужно? Все просто! Обычно, сервер 1С запущен от учетной записи, которая не позволяет рабочим процессам получать доступ к базе напрямую (либо доменная учетная запись не имеет доступ к базе, либо доступ закрыт другими способами). Однако доступ может быть у разработчика / администратора с помощью доменной учетной записи, от которой и запущено клиентское приложение. С помощью этого флага такие ограничения можно безопасно и легально обойти. Конечно, получение данных из базы данных с помощью клиентского приложения 1С может работать медленнее, это стоит учитывать.
* Сервер - адрес сервера СУБД. Не забудьте если что указать имя инстанса, если оно отличается от стандартного (это для SQL Server).
* Имя базы данных - это имя базы данных (внезапно) на сервере СУБД.
* Аутентификация Windows - установите для использования аутентификации средствами NTLM (если у Вас доменная учетная запись и для нее есть доступ на СУБД, то идеальный вариант для подключения).
* Таймаут подключения (сек.) - время, которое соединение с сервером баз данных будет ожидать ответа. По умолчанию - 3 минуты. Если соединение медленное и отчет не успевает получить все данные, то можете увеличить время таймаута под себя.
* Имя пользователя - имя пользователя для доступа к СУБД. Если аутентификация Windows недоступна, то это единственный оставшийся вариант.
* Пароль - пароль пользователя для доступа к СУБД.
* Сохранять пароль - при включенной опции пароль от пользователя СУБД будет сохраняться в общих настройках. Не рекомендую этого делать, т.к. безопасность хранения пароля в таком виде = 0. Можно использовать на тестовом окружении, и то не всегда.

На форме также доступна команда "Проверить подключение". Не забывайте проверять работоспособность настроек после изменения.

Все просто, не правда ли?

Есть некоторые особенности при работе с *.nix системами. Поскольку отчет в текущей версии использует ADO для подключения к базе данных, то выполняться он может только на платформе Windows. Если же Вы счастливчик и сервер 1С установлен на Linux, то выход все же есть:

* Запустить клиентское приложение 1С:Предприятие на платформе Windows.
* В настройках подключения отчета установить опцию "Запросы с клиента"
* Убедиться, что на клиентском компьютере есть необходимые поставщики данных для подключения к базе:
    * Для SQL Server
    * Для PostgreSQL
* Все, отчет должен работать!

Классическим вариантом отчета является "Таблицы хранения (основная)".

![3. Пример сформированного отчета](./media/3.%20%D0%9F%D1%80%D0%B8%D0%BC%D0%B5%D1%80%20%D1%81%D1%84%D0%BE%D1%80%D0%BC%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%BD%D0%BE%D0%B3%D0%BE%20%D0%BE%D1%82%D1%87%D0%B5%D1%82%D0%B0.png)

Да, пока есть привязка к Windows, возможно в будущем ситуация изменится. Сейчас же это значительно упрощает реализацию отчета.

## Требования

Основные требования к работе:

* Платформа 1С версии 8.3.5 и выше.
* Внутри отчета используется кэширование данных, получение только необходимых данных в зависимости от настроек отчета и еще некоторые фичи.
* Полноценно работает только в клиент-серверном режиме.

Отчет поддерживает работу в файловом варианте информационной базы, но в ограниченном режиме - доступен только просмотр структуры базы данных, полученный с помощью штатного метода "ПолучитьСтруктуруХраненияБазыДанных()". Весь расширенный функционал доступен только для клиент-серверного варианта работы платформы 1С в связке с такими СУБД как SQL Server и PostgreSQL.

## Варианты отчетов

Основные варианты отчета.

### Таблицы хранения (только структура)

![4. Таблица хранения (только структура)](./media/4.%20%D0%A2%D0%B0%D0%B1%D0%BB%D0%B8%D1%86%D0%B0%20%D1%85%D1%80%D0%B0%D0%BD%D0%B5%D0%BD%D0%B8%D1%8F%20(%D1%82%D0%BE%D0%BB%D1%8C%D0%BA%D0%BE%20%D1%81%D1%82%D1%80%D1%83%D0%BA%D1%82%D1%83%D1%80%D0%B0).png)

### Таблицы хранения (основная)

![5. Таблица хранения (основная)](./media/4.%20%D0%A2%D0%B0%D0%B1%D0%BB%D0%B8%D1%86%D0%B0%20%D1%85%D1%80%D0%B0%D0%BD%D0%B5%D0%BD%D0%B8%D1%8F%20(%D1%82%D0%BE%D0%BB%D1%8C%D0%BA%D0%BE%20%D1%81%D1%82%D1%80%D1%83%D0%BA%D1%82%D1%83%D1%80%D0%B0).png)

### Таблицы хранения (с полями)

![6. Таблица хранения (с полями)](./media/6.%20%D0%A2%D0%B0%D0%B1%D0%BB%D0%B8%D1%86%D0%B0%20%D1%85%D1%80%D0%B0%D0%BD%D0%B5%D0%BD%D0%B8%D1%8F%20(%D1%81%20%D0%BF%D0%BE%D0%BB%D1%8F%D0%BC%D0%B8).png)

### Таблицы хранения (с полями, расширенный)

![7. Таблица хранения (с полями, расширенный)](./media/7.%20%D0%A2%D0%B0%D0%B1%D0%BB%D0%B8%D1%86%D0%B0%20%D1%85%D1%80%D0%B0%D0%BD%D0%B5%D0%BD%D0%B8%D1%8F%20(%D1%81%20%D0%BF%D0%BE%D0%BB%D1%8F%D0%BC%D0%B8%2C%20%D1%80%D0%B0%D1%81%D1%88%D0%B8%D1%80%D0%B5%D0%BD%D0%BD%D1%8B%D0%B9).png)

### Таблицы хранения (с индексами)

![8. Таблица хранения (с индексами)](./media/8.%20%D0%A2%D0%B0%D0%B1%D0%BB%D0%B8%D1%86%D0%B0%20%D1%85%D1%80%D0%B0%D0%BD%D0%B5%D0%BD%D0%B8%D1%8F%20(%D1%81%20%D0%B8%D0%BD%D0%B4%D0%B5%D0%BA%D1%81%D0%B0%D0%BC%D0%B8).png)

### Таблицы хранения (с индексами, расширенный)

![9. Таблица хранения (с индексами, расширенный)](./media/9.%20%D0%A2%D0%B0%D0%B1%D0%BB%D0%B8%D1%86%D0%B0%20%D1%85%D1%80%D0%B0%D0%BD%D0%B5%D0%BD%D0%B8%D1%8F%20(%D1%81%20%D0%B8%D0%BD%D0%B4%D0%B5%D0%BA%D1%81%D0%B0%D0%BC%D0%B8%2C%20%D1%80%D0%B0%D1%81%D1%88%D0%B8%D1%80%D0%B5%D0%BD%D0%BD%D1%8B%D0%B9).png)

### Использовано места по видам объектов

![10. Использовано места по видам объектов](./media/10.%20%D0%98%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%BE%20%D0%BC%D0%B5%D1%81%D1%82%D0%B0%20%D0%BF%D0%BE%20%D0%B2%D0%B8%D0%B4%D0%B0%D0%BC%20%D0%BE%D0%B1%D1%8A%D0%B5%D0%BA%D1%82%D0%BE%D0%B2.png)

### Количество записей по видам объектов

![11. Количество записей по видам объектов](./media/11.%20%D0%9A%D0%BE%D0%BB%D0%B8%D1%87%D0%B5%D1%81%D1%82%D0%B2%D0%BE%20%D0%B7%D0%B0%D0%BF%D0%B8%D1%81%D0%B5%D0%B9%20%D0%BF%D0%BE%20%D0%B2%D0%B8%D0%B4%D0%B0%D0%BC%20%D0%BE%D0%B1%D1%8A%D0%B5%D0%BA%D1%82%D0%BE%D0%B2.png)

### ТОП 10 объектов по размеру

![12. ТОП 10 объектов по размеру](./media/12.%20%D0%A2%D0%9E%D0%9F%2010%20%D0%BE%D0%B1%D1%8A%D0%B5%D0%BA%D1%82%D0%BE%D0%B2%20%D0%BF%D0%BE%20%D1%80%D0%B0%D0%B7%D0%BC%D0%B5%D1%80%D1%83.png)

### ТОП 10 объектов по количеству записей

![13. ТОП 10 объектов по количеству записей](./media/13.%20%D0%A2%D0%9E%D0%9F%2010%20%D0%BE%D0%B1%D1%8A%D0%B5%D0%BA%D1%82%D0%BE%D0%B2%20%D0%BF%D0%BE%20%D0%BA%D0%BE%D0%BB%D0%B8%D1%87%D0%B5%D1%81%D1%82%D0%B2%D1%83%20%D0%B7%D0%B0%D0%BF%D0%B8%D1%81%D0%B5%D0%B9.png)

### ТОП 10 объектов по количеству записей

![14. Неиспользуемые объекты](./media/14.%20%D0%9D%D0%B5%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D1%83%D0%B5%D0%BC%D1%8B%D0%B5%20%D0%BE%D0%B1%D1%8A%D0%B5%D0%BA%D1%82%D1%8B.png)

## Без заключения

Но не останавливайтесь на том, что есть! Импровизируйте, настраивайте, экспериментируйте! Создайте свой вариант с блэкджеком и кастомизацией!